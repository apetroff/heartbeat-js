<!DOCTYPE html>
<html>
<head></head>
<body>
	<!--table style="WIDTH:100%;" class="grid-header" border="0">
		<colgroup>
			<col width="28px/">
			<col width="300px/">
			<col width="150px/">
			<col width="250px/">
			<col width="100px/">
			<col width="90px/">
		</colgroup>
		<tbody id="tbodyQwerty">
			<tr>
				<th title=" " colspan="1" rowspan="1" class="header-cell">&nbsp;</th>
				<th title="Краткое наименование" colspan="1" rowspan="1" class="header-cell">Краткое наименование</th>
				<th title="Регион" colspan="1" rowspan="1" class="header-cell">Регион</th>
				<th title="Отрасль" colspan="1" rowspan="1" class="header-cell">Отрасль</th>
				<th title="ИНН" colspan="1" rowspan="1" class="header-cell">ИНН</th>
				<th title="ОКПО" colspan="1" rowspan="1" class="header-cell">ОКПО</th>
			</tr>
		</tbody>
	</table-->
	
	<script>
		//var listISIN = 'RU0009029540 RU0007661625 RU0009024277 RU0007288411 RU000A0JP5V6 RU000A0J2Q06 RU0008926258 RU000A0JPVJ0 RU0009046510 RU000A0JPNN9 RU0009046452 RU000A0JPKH7 RU0007661302 RU000A0JPNM1 RU0008943394 RU0009062285 RU000A0DKVS5 RU0009033591 RU000A0JKQU8 RU0007775219 RU0009062467 RU000A0DKXV5 RU0009084396 RU000A0B90N8 RU000A0HGPM9 RU000A0JNGA5 RU000A0JNG55 RU000A0JNAA8 RU000A0DQZE3 RU000A0JPFP0 RU000A0JP7F5 RU0008958863 RU000A0JPPL8 RU000A0JNUD0 RU0009028674 RU000A0HG4P4 RU0009071187 RU000A0JQU47 RU0009100291 RU0008959580 RU0006914488 RU000A0JR6A6 RU0005294775 RU0007252813 RU000A0ET7Y7 RU0009100945 RU0008081765 RU0007664942 RU0009107684 RU000A0JPGA0'.split(' ');
		var idsList = ["1519","7785","8085","7805","1435","8233","8617","8801","8529","8793","8257","8473","8761","7913","8461","7697","8245","8633","8089","8209","7781","8113","8093","8417","12240","8321","8313","8405","8889","7813","8785","8157","8201","8649","7653","7817","7633","12715","8005","7953","8597","63715","8869","12219","8173","1423","7669","12727","8389","7985"];
		
		//var primeUrlSearchIds = 'http://emitent.1prime.ru/EmitentPages/EmitentSearchResultGrid.aspx';
		var primeUrlInfo = 'http://emitent.1prime.ru/EmitentPages/EmitentGeneralGrid.aspx';
		//var primeUrlDescription = 'http://emitent.1prime.ru/EmitentPages/EmitentActivitiesGrid.aspx';
		//var primeUrlIntraday = 'http://emitent.1prime.ru/EmitentPages/EmitentCompareFoTickerIntradayGrid.aspx';
		//var primeUrlYear = 'http://emitent.1prime.ru/EmitentPages/EmitentCompareFoTickerResultsByDateGrid.aspx';
		
		var reactor = document.createElement('div');
		//var renderTo = document.getElementById('tbodyQwerty');
		var renderTo = document.body;
		
//		function getXmlSerISIN(isin) {
//		
//			return '<request><pageNumber>1</pageNumber><rowsOnPage>50</rowsOnPage>'
//				+'<orderCondition><order/></orderCondition><forExcel>0</forExcel><forWord>0</forWord><Name></Name>'
//				+'<CodeType>-1</CodeType><regionList></regionList><regionListStr></regionListStr><branchList></branchList>'
//				+'<branchListStr></branchListStr><pocList></pocList><pocListStr></pocListStr><emitentTypeList>1 2 3 4</emitentTypeList>'
//				+'<INN></INN><tiker></tiker><OKPO></OKPO><ISIN>'
//				+ isin
//				+'</ISIN><OGRN></OGRN><regNumBank></regNumBank><codeFSFR></codeFSFR><regNumStrah></regNumStrah><OKATO></OKATO>'
//				+'<pocSearchType>0</pocSearchType><pocIntervalType>0</pocIntervalType><pocFromYear>2011</pocFromYear>'
//				+'<pocToYear>2012</pocToYear><pocOfQ>1</pocOfQ><pocOfY>2012</pocOfY><isTrading>0</isTrading>'
//				+'<showCol>ShortName Region Branch Ticker</showCol></request>';
//		}

		function getXmlSerID(id) {
		
			return '<request><EmitentId>'
				+ id
				+ '</EmitentId></request>';
		}
		
//		function getXmlIntradaySerID(id) {
//		
//			return '<request><pageNumber>1</pageNumber>'
//				+'<isEmitentCard>1</isEmitentCard><groupExchangeList>2 </groupExchangeList>'
//				+'<groupInstrumentTypeList>1 </groupInstrumentTypeList><idList>'
//				+id
//				+'</idList><showCol>Name ExchangeName Code ActionName Last High Low ChangeProc Bid_ Ask WA Trade VDay VRub VDol</showCol>'
//				+'<parentId>EmitentQuotesIntraday</parentId></request>';
//		}
		
//		function getXmlIntradaySerID(id) {
//		
//			return '<request>'
//				+'<isEmitentCard>1</isEmitentCard><groupExchangeList>2 </groupExchangeList>'
//				+'<groupInstrumentTypeList>1 </groupInstrumentTypeList><idList>'
//				+id
//				+'</idList><showCol>Name ExchangeName Code ActionName Last High Low ChangeProc Bid_ Ask WA Trade VDay VRub VDol</showCol>'
//				+'<parentId>EmitentQuotesIntraday</parentId></request>';
//		}
//		
//		function getXmlYearSerID(id) {
//		
//			return '<request>'
//				+'<compareDate>16.04.2012</compareDate>'
//				+'<isEmitentCard>1</isEmitentCard><groupExchangeList>2 </groupExchangeList><groupInstrumentTypeList>1 </groupInstrumentTypeList><idList>'
//				+id
//				+'</idList><showCol>Name ADate ExchangeName Code ActionName Close High Low ChangeProc Bid_ Ask WA Trade VDay VRub VDol</showCol>'
//				+'<parentId>EmitentQuotesArchive</parentId></request>';
//		}

		var companies = {};
		
//		function loadSearchResultByISIN(isin) {
//			
//			var xhr = new XMLHttpRequest();
//			
//			var url = primeUrlSearchIds,
//				headers = {
//					"Content-Type": "application/estyle-xml-request",
//					"Origin": "http://emitent.1prime.ru",
//					"Referer": "http://emitent.1prime.ru/EmitentPages/EmitentSearchResult.aspx"
//				};
//			
//			xhr.open('POST', 'http://collaboratoria.local/proxy/post', true);
//			xhr.setRequestHeader('Content-Type', 'application/json');
//			
//			xhr.onreadystatechange = function (event) {  
//				
//				if (xhr.readyState === 4) {  
//					if (xhr.status === 200) {
//						reactor.innerHTML = xhr.responseText;
//						var row = reactor.querySelector('tr.even-row');
//						renderTo.appendChild(row);
//						parse(row);
//						while (reactor.firstChild) reactor.removeChild(reactor.firstChild);
//						if (listISIN.length) {
//							loadSearchResultByISIN(listISIN.shift());
//						} else {
//							console.log (companies);
//							copy(JSON.stringify({companies: companies}));
//						}
//					} else {  
//						console.log("Error", xhr.statusText);  
//					}
//				}
//			};
//			
//			
//			xhr.send(JSON.stringify({url: url, headers: headers, request: getXmlSerISIN(isin)}));
//		}
//		
//		loadSearchResultByISIN(listISIN.shift());
//		
//		function parse(row) {
//		
//			var id = row.id,
//				title = row.childNodes[1].title.replace(/(ОАО |«|»)/g,''),
//				tickers = row.childNodes[2].title.split(', '),
//				region = row.childNodes[3].title.replace(/ \(.+\)/g,''),
//				sector = row.childNodes[4].title;
//			
//			companies.push({
//				id: id,
//				title: title,
//				tickers: tickers,
//				region: region,
//				sector: sector
//			});
//		}
		function loadInfoByID(id) {
			
			var xhr = new XMLHttpRequest();
			
			var url = primeUrlInfo,
				headers = {
					"Content-Type": "application/estyle-xml-request",
					"Origin": "http://emitent.1prime.ru",
					"Referer": "http://emitent.1prime.ru/EmitentPages/EmitentQuotesIntraday.aspx?EmitentId=" + id
				};
			
			xhr.open('POST', 'http://collaboratoria.local/proxy/post?url='+url+'&headers='+headers, true);
			xhr.setRequestHeader('Content-Type', 'application/json');
			
			xhr.onreadystatechange = function (event) {  
				
				if (xhr.readyState === 4) {  
					if (xhr.status === 200) {
						reactor.innerHTML = xhr.responseText;
						var row = reactor.querySelector('table#GridBuilderGeneral_headTable tbody');
						renderTo.appendChild(row);
						parse(row, id);
						while (reactor.firstChild) reactor.removeChild(reactor.firstChild);
						if (idsList.length) loadInfoByID(idsList.shift());
					} else {  
						console.log("Error", xhr.statusText);  
					}
				}
			};
			
			
			xhr.send(JSON.stringify({
				url: url,
				headers: headers,
				request: getXmlSerID(id)
			}));
		}
		
		loadInfoByID(idsList.shift());
		
		var infos = {}
		
		var rowsMap = {
			'Полное наименование': 'fullTitle',
			'Краткое наименование': 'shortTitle',
			'Юридический адрес': 'address',
			'Сайт в Интернете': 'site',
			'Руководитель': 'ceo',
			'Отрасль': 'sector',
			'Сфера деятельности': 'field',
			'Уставный капитал, тыс. руб.': 'authCapital',
			'Регион': 'region',
			'Количество учредителей': 'coFounderCount',
			'Лицензии': 'licenceList'
		};
		
		function parse(tbody, id) {
		
			var leftCells = tbody.querySelectorAll('td:first-child');
			
			var info = {};
			
			for (var i = 0; i < leftCells.length; i++) {
				
				var title = leftCells[i].title;
				
				if (rowsMap[title]) {
					info[rowsMap[title]] = leftCells[i].nextElementSibling.title;
				}			
			}
			
			infos[id] = info;
		}

//		function loadDescriptionByID(id) {
//			
//			var xhr = new XMLHttpRequest();
//			
//			var url = primeUrlDescription,
//				headers = {
//					"Content-Type": "application/estyle-xml-request",
//					"Origin": "http://emitent.1prime.ru",
//					"Referer": "http://emitent.1prime.ru/EmitentPages/EmitentActivities.aspx?EmitentId=" + id
//				};
//			
//			xhr.open('POST', 'http://collaboratoria.local/proxy/post', true);
//			xhr.setRequestHeader('Content-Type', 'application/json');
//			
//			xhr.addEventListener('readystatechange', function (event) {  
//				
//				if (xhr.readyState === 4) {  
//					if (xhr.status === 200) {
//						reactor.innerHTML = xhr.responseText;
//						var row = reactor.querySelector('table#GridBuilderGeneral_headTable tbody tr td');
//						companies[id] = row.innerHTML;
//						renderTo.appendChild(row);
//						row.id = id;
//						while (reactor.firstChild) reactor.removeChild(reactor.firstChild);
//						if (idsList.length) loadDescriptionByID(idsList.shift());
//						else console.log (companies);
//					} else {  
//						console.log("Error", xhr.statusText);  
//					}
//				}
//			});
//			
//			
//			xhr.send(JSON.stringify({
//				url: url,
//				headers: headers,
//				request: getXmlSerID(id)
//			}));
//		}
//		
//		loadDescriptionByID(idsList.shift());

//		function loadIntradayByID(id) {
//			
//			var xhr = new XMLHttpRequest();
//			
//			var url = encodeURI(primeUrlIntraday),
//				headers = encodeURI(JSON.stringify({
//					"Content-Type": "application/estyle-xml-request",
//					"Origin": "http://emitent.1prime.ru",
//					"Referer": "http://emitent.1prime.ru/EmitentPages/EmitentQuotesIntraday.aspx?EmitentId=" + id
//				}));
//			
//			xhr.open('POST', 'http://collaboratoria.local/proxy/post?url='+url+'&headers='+headers, true);
//			
//			xhr.onreadystatechange = function (event) {  
//				
//				if (xhr.readyState === 4) {  
//					if (xhr.status === 200) {
//						reactor.innerHTML = xhr.responseText;
//						var row = reactor.querySelector('tr.even-row');
//						renderTo.appendChild(row);
//						while (reactor.firstChild) reactor.removeChild(reactor.firstChild);
//						if (idsList.length) loadIntradayByID(idsList.shift());
//					} else {  
//						console.log("Error", xhr.statusText);  
//					}
//				}
//			};
//			
//			
//			xhr.send(getXmlSerID(id));
//		}
//		
//		loadIntradayByID(idsList.shift());

//		function loadYearByID(id) {
//			
//			var xhr = new XMLHttpRequest();
//			
//			var url = encodeURI(primeUrlYear),
//				headers = encodeURI(JSON.stringify({
//					"Content-Type": "application/estyle-xml-request",
//					"Origin": "http://emitent.1prime.ru",
//					"Referer": "http://emitent.1prime.ru/EmitentPages/EmitentQuotesArchive.aspx?EmitentId=" + id
//				}));
//			
//			xhr.open('POST', 'http://collaboratoria.local/proxy/post?url='+url+'&headers='+headers, true);
//			
//			xhr.onreadystatechange = function (event) {  
//				
//				if (xhr.readyState === 4) {  
//					if (xhr.status === 200) {
//						reactor.innerHTML = xhr.responseText;
//						var row = reactor.querySelector('tr.even-row');
//						if (!row) return;
//						renderTo.appendChild(row);
//						while (reactor.firstChild) reactor.removeChild(reactor.firstChild);
//						if (idsList.length) loadYearByID(idsList.shift());
//					} else {  
//						console.log("Error", xhr.statusText);  
//					}
//				}
//			};
//			
//			
//			xhr.send(getXmlYearSerID(id));
//		}
//		
//		loadYearByID(idsList.shift());
		
	</script>
	
	<!--script>
	
	// PIEF persons
	// PIEF shedule
	
	var memberList = document.querySelectorAll('#memb_list_bls td:not(.space)');
	var topicsNamesList = document.querySelectorAll('#topics_menu a');
	var topicsList = document.querySelectorAll('#topics_bl article');
	var persons = {};
	
	for (var i=0;i<memberList.length;i++) {
		var person = memberList[i];
		if (!person. childElementCount) break;
		var names = person.querySelector('strong').textContent.split(/\s+/),
			surname = names.pop(),
			name = names.join(' ');
			
		console.log (person);
			
		persons[name+' '+surname] = {
			avatar: person.querySelector('img').src,
			surname: surname,
			name: name,
			post: person.querySelector('p').textContent,
			country: person.querySelector('span').textContent
		};
	}
	
	var shedule = [],
		personId = 1,
		sessionId = 1;
	
	for (var i=0; i<topicsNamesList.length; i++) {
		
		var topicName = topicsNamesList[i].innerText.replace('\n',' '),
			sections = topicsList[i].querySelectorAll('p.theme');
			
		for(var j=0; j < sections.length; j++) {
			var section = sections[j],
				sectionName = section.querySelector('strong');
			if (sectionName) {
				sectionName = sectionName.innerText.replace('\n',' ');
				if (section.nextElementSibling && section.nextElementSibling.nodeName == 'UL') {
					var memberList = section.nextElementSibling.querySelectorAll('li'),
						members = [];
					for (var k=0; k < memberList.length; k++) {
						var member = memberList[k].textContent;
						if (member) {
							member = member.split(', ');
							var names = member.shift().split(' ')
								surname = names.pop()
								name = names.join(' ');
							var p = persons[name+' '+surname] || {surname: surname, name: name, post: member.join(', '), avatar: '', country: ''};
							if (!p['id']) p['id'] = personId++;
							members.push(p);
						}
					}
				}
				
				shedule.push({
					title: sectionName,
					topic: topicName,
					speakers: members
				});
			}
		}
	}
	
	var startDate = new Date('Jun 21 2012 10:00:00 GMT+0400 (MSK)'),
		endDate = new Date('Jun 23 2012 00:00:00 GMT+0400 (MSK)'),
		sectionsPerDay = ~~(shedule.length/(endDate.getDay() - startDate.getDay()+1)+1),
		sectionDuration = 3600*1000,
		day = 24*3600*1000,
		topicCount = topicsList.length,
		j = 0;
		
	endDate.setTime(startDate.getTime());
		
	shedule.forEach(function(section, i) {
		
		console.log(i % sectionsPerDay, j % topicCount);
		
		if (i % sectionsPerDay == 0 && i != 0) {
			startDate.setTime(startDate.getTime() + day);
			endDate.setTime(startDate.getTime());
			j = 0;
		} else if (j % topicCount == 0 && j != 0) {
			endDate.setTime(endDate.getTime() + sectionDuration);
		}
		j++;
		section.id = sessionId++;
		section.startDate = endDate.toString();
		section.endDate = new Date(endDate.getTime() + sectionDuration).toString();
	})
			
	console.log ({sessions: shedule});
	 
	copy(JSON.stringify({sessions: shedule}));
	
	</script-->
</body>
</html>